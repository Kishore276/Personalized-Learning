<!-- Quiz Modal -->
<div class="modal fade" id="quizModal" tabindex="-1" aria-labelledby="quizModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quizModalLabel">Quiz Selection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="quizContent">
                    <div class="mb-3">
                        <label for="courseSelect" class="form-label">Select Course:</label>
                        <select class="form-select" id="courseSelect" aria-label="Course selection">
                            <option value="">Loading courses...</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="levelSelect" class="form-label">Select Difficulty Level:</label>
                        <select class="form-select" id="levelSelect" aria-label="Difficulty level selection">
                            <option value="">Select level</option>
                            <option value="basic">Basic</option>
                            <option value="medium">Medium</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="startQuizBtn" disabled>Start Quiz</button>
            </div>
        </div>
    </div>
</div>

<script>
// Quiz Modal functionality with proper accessibility handling
document.addEventListener('DOMContentLoaded', function() {
    const quizModal = document.getElementById('quizModal');
    const quizContent = document.getElementById('quizContent');
    const startQuizBtn = document.getElementById('startQuizBtn');
    const courseSelect = document.getElementById('courseSelect');
    const levelSelect = document.getElementById('levelSelect');
    
    // Handle modal events for proper accessibility
    quizModal.addEventListener('show.bs.modal', function (event) {
        // Remove aria-hidden when modal is showing
        this.removeAttribute('aria-hidden');
        // Load courses when modal opens
        loadAvailableCourses();
    });
    
    quizModal.addEventListener('hide.bs.modal', function (event) {
        // Reset modal content when hiding
        resetQuizModal();
    });
    
    quizModal.addEventListener('hidden.bs.modal', function (event) {
        // Set aria-hidden after modal is completely hidden
        this.setAttribute('aria-hidden', 'true');
    });
    
    function resetQuizModal() {
        courseSelect.innerHTML = '<option value="">Loading courses...</option>';
        levelSelect.value = '';
        startQuizBtn.disabled = true;
        startQuizBtn.style.display = 'block'; // Show the start quiz button
        
        // Reset to selection screen
        quizContent.innerHTML = `
            <div class="mb-3">
                <label for="courseSelect" class="form-label">Select Course:</label>
                <select class="form-select" id="courseSelect" aria-label="Course selection">
                    <option value="">Loading courses...</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label for="levelSelect" class="form-label">Select Difficulty Level:</label>
                <select class="form-select" id="levelSelect" aria-label="Difficulty level selection">
                    <option value="">Select level</option>
                    <option value="basic">Basic</option>
                    <option value="medium">Medium</option>
                    <option value="advanced">Advanced</option>
                </select>
            </div>
        `;
        
        // Re-bind events
        setupQuizSelection();
    }
    
    function loadAvailableCourses() {
        const courseSelect = document.getElementById('courseSelect');
        
        // Load available courses from quiz JSON files
        fetch('/api/quiz/available-courses')
            .then(response => response.json())
            .then(data => {
                courseSelect.innerHTML = '<option value="">Choose...</option>';
                
                if (data.courses) {
                    data.courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.title;
                        option.setAttribute('data-filename', course.filename);
                        courseSelect.appendChild(option);
                    });
                }
                
                setupQuizSelection();
            })
            .catch(error => {
                console.error('Error loading courses:', error);
                courseSelect.innerHTML = '<option value="">Error loading courses</option>';
            });
    }
    
    function setupQuizSelection() {
        const courseSelect = document.getElementById('courseSelect');
        const levelSelect = document.getElementById('levelSelect');
        const startQuizBtn = document.getElementById('startQuizBtn');
        
        function checkSelections() {
            if (courseSelect.value && levelSelect.value) {
                startQuizBtn.disabled = false;
            } else {
                startQuizBtn.disabled = true;
            }
        }
        
        courseSelect.addEventListener('change', checkSelections);
        levelSelect.addEventListener('change', checkSelections);
        
        startQuizBtn.onclick = function() {
            const selectedCourse = courseSelect.value;
            const selectedLevel = levelSelect.value;
            if (selectedCourse && selectedLevel) {
                // Close modal and redirect to quiz page with parameters
                const modal = bootstrap.Modal.getInstance(quizModal);
                modal.hide();
                
                // Redirect to quiz page with course and level parameters
                const quizUrl = `/quiz_page?course=${selectedCourse}&level=${selectedLevel}`;
                window.open(quizUrl, '_blank');
            }
        };
    }
    
    window.startQuickAssessment = function(courseId) {
        console.log('Opening quiz selection modal');
        
        // Show modal
        const modal = new bootstrap.Modal(quizModal);
        modal.show();
    };
});
</script>
